<!doctype html>
<html lang="de" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Texteditor</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.5;
      color: #111827;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    /* Utility Classes (replacing Tailwind) */
    .h-full { height: 100%; }
    .w-full { width: 100%; }
    .min-h-full { min-height: 100%; }
    .max-w-md { max-width: 28rem; }
    .max-w-2xl { max-width: 42rem; }
    .max-w-xl { max-width: 36rem; }
    .max-w-4xl { max-width: 56rem; }
    
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .flex-wrap { flex-wrap: wrap; }
    .items-center { align-items: center; }
    .items-start { align-items: flex-start; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .justify-end { justify-content: flex-end; }
    .gap-2 { gap: 0.5rem; }
    .gap-4 { gap: 1rem; }
    .gap-6 { gap: 1.5rem; }
    .gap-8 { gap: 2rem; }
    
    .hidden { display: none; }
    .block { display: block; }
    .inline-block { display: inline-block; }
    .grid { display: grid; }
    .grid-cols-8 { grid-template-columns: repeat(8, minmax(0, 1fr)); }
    
    .fixed { position: fixed; }
    .absolute { position: absolute; }
    .relative { position: relative; }
    .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
    
    .z-30 { z-index: 30; }
    .z-40 { z-index: 40; }
    .z-50 { z-index: 50; }
    
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .p-8 { padding: 2rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
    .pr-8 { padding-right: 2rem; }
    .pr-12 { padding-right: 3rem; }
    
    .m-0 { margin: 0; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    .mx-1 { margin-left: 0.25rem; margin-right: 0.25rem; }
    .mx-4 { margin-left: 1rem; margin-right: 1rem; }
    .mt-3 { margin-top: 0.75rem; }
    
    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-full { border-radius: 9999px; }
    
    .border { border-width: 1px; }
    .border-2 { border-width: 2px; }
    .border-b-2 { border-bottom-width: 2px; }
    .border-none { border: none; }
    
    .text-xs { font-size: 0.75rem; line-height: 1rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-base { font-size: 1rem; line-height: 1.5rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-2xl { font-size: 1.5rem; line-height: 2rem; }
    .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
    
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .italic { font-style: italic; }
    .line-through { text-decoration: line-through; }
    .underline { text-decoration: underline; }
    
    .text-center { text-align: center; }
    .leading-relaxed { line-height: 1.625; }
    
    .overflow-auto { overflow: auto; }
    .overflow-y-auto { overflow-y: auto; }
    
    .cursor-pointer { cursor: pointer; }
    
    .transition-all { transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
    
    .transform { transform: translate(var(--tw-translate-x), var(--tw-translate-y)); }
    .-translate-y-1\/2 { --tw-translate-y: -50%; transform: translateY(-50%); }
    
    .flex-1 { flex: 1 1 0%; }
    .w-1\/3 { width: 33.333333%; }
    .w-2\/3 { width: 66.666667%; }
    .w-8 { width: 2rem; }
    .h-8 { height: 2rem; }
    .w-96 { width: 24rem; }
    .w-px { width: 1px; }
    
    /* Color Classes */
    .bg-white { background-color: #ffffff; }
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-gray-200 { background-color: #e5e7eb; }
    .bg-gray-300 { background-color: #d1d5db; }
    .bg-gray-400 { background-color: #9ca3af; }
    .bg-blue-50 { background-color: #eff6ff; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-blue-700 { background-color: #1d4ed8; }
    .bg-green-600 { background-color: #16a34a; }
    .bg-green-700 { background-color: #15803d; }
    .bg-red-600 { background-color: #dc2626; }
    .bg-red-700 { background-color: #b91c1c; }
    .bg-orange-600 { background-color: #ea580c; }
    .bg-orange-700 { background-color: #c2410c; }
    
    .bg-black { background-color: #000000; }
    .bg-opacity-50 { background-color: rgba(0, 0, 0, 0.5); }
    
    .text-white { color: #ffffff; }
    .text-gray-500 { color: #6b7280; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-700 { color: #374151; }
    .text-gray-800 { color: #1f2937; }
    .text-blue-600 { color: #2563eb; }
    .text-red-600 { color: #dc2626; }
    .text-green-600 { color: #16a34a; }
    
    .border-gray-200 { border-color: #e5e7eb; }
    .border-gray-300 { border-color: #d1d5db; }
    .border-blue-200 { border-color: #bfdbfe; }
    .border-blue-500 { border-color: #3b82f6; }
    
    /* Hover States */
    .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
    .hover\:bg-gray-200:hover { background-color: #e5e7eb; }
    .hover\:bg-gray-300:hover { background-color: #d1d5db; }
    .hover\:bg-gray-400:hover { background-color: #9ca3af; }
    .hover\:bg-blue-100:hover { background-color: #dbeafe; }
    .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
    .hover\:bg-green-700:hover { background-color: #15803d; }
    .hover\:bg-red-700:hover { background-color: #b91c1c; }
    .hover\:bg-orange-700:hover { background-color: #c2410c; }
    .hover\:text-gray-700:hover { color: #374151; }
    .hover\:text-gray-800:hover { color: #1f2937; }
    .hover\:border-blue-500:hover { border-color: #3b82f6; }
    
    /* Focus States */
    .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
    .focus\:border-blue-500:focus { border-color: #3b82f6; }
    
    /* Shadow */
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    
    /* Custom Styles */
    .app-container {
      height: 100%;
      width: 100%;
      overflow: auto;
      background: #e5e7eb;
    }
    
    .bg-image-overlay {
      background-image: url('https://wlw-steuern.de/storage/files/shares/Bilder/Videos%20Website/Crashkurs.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .card-overlay {
      background-color: rgba(255, 255, 255, 0.95);
    }
    
    .editor-content {
      min-height: 500px;
      outline: none;
      font-family: 'Arial', sans-serif;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .editor-content:focus {
      outline: none;
      border: none;
    }
    
    #editor {
      outline: none !important;
      border: none !important;
    }
    
    #editor ul {
      list-style-type: disc;
      margin-left: 30px;
      padding-left: 10px;
    }
    
    #editor ol {
      list-style-type: decimal;
      margin-left: 30px;
      padding-left: 10px;
    }
    
    #editor li {
      margin: 5px 0;
    }
    
    #editor h2 {
      font-size: 22px;
      font-weight: bold;
      margin: 15px 0 10px 0;
      line-height: 1.3;
    }
    
    .toolbar-button {
      transition: all 0.2s;
    }
    
    .toolbar-button:hover {
      transform: translateY(-1px);
    }
    
    .toolbar-button:active {
      transform: translateY(0);
    }
    
    .toolbar-button.active {
      background-color: #3b82f6;
      color: white;
    }
    
    .dialog-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    
    .top-80 {
      top: 80px;
    }
    
    .top-4 {
      top: 1rem;
    }
    
    .right-3 {
      right: 0.75rem;
    }
    
    .right-4 {
      right: 1rem;
    }
    
    .max-h-80 {
      max-height: 80%;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      
      #printContent, #printContent * {
        visibility: visible;
      }
      
      #printContent {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        display: block !important;
      }
      
      @page {
        size: A4;
        margin: 2cm;
      }
      
      .print-header {
        display: block;
        padding: 15px 0;
        border-bottom: 2px solid #333;
        margin-bottom: 30px;
        font-size: 11pt;
        page-break-after: avoid;
      }
      
      .print-content {
        display: block;
        margin-top: 0;
        padding-top: 0;
        font-family: 'Arial', sans-serif;
        font-size: 12pt;
        line-height: 1.6;
        color: #000;
      }
      
      .print-content div[style*="page-break-after: always"] {
        page-break-after: always;
      }
      
      .print-content table {
        border-collapse: collapse;
        width: 100%;
        page-break-inside: avoid;
      }
      
      .print-content table td {
        border: 1px solid #000;
        padding: 5px;
      }
      
      .print-content h1, .print-content h2, .print-content h3 {
        page-break-after: avoid;
      }
      
      .print-content p {
        orphans: 3;
        widows: 3;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="app-container"><!-- Password Screen -->
   <div id="passwordScreen" class="min-h-full flex items-center justify-center px-4 py-8 bg-image-overlay">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full card-overlay">
     <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Zugangskontrolle</h1>
     <p class="text-gray-600 mb-6 text-center">Bitte geben Sie das Passwort ein, um fortzufahren.</p>
     <form id="passwordForm"><label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Passwort:</label>
      <div class="relative mb-4"><input type="password" id="password" required class="w-full px-4 py-3 pr-12 border-2 border-gray-300 rounded-lg focus-border-blue-500 focus-outline-none" placeholder="Passwort eingeben..." style="padding-right: 3rem; border: 2px solid #d1d5db; border-radius: 0.5rem;"> <button type="button" id="togglePasswordBtn" class="absolute right-3 text-gray-500 hover-text-gray-700 focus-outline-none" style="top: 50%; transform: translateY(-50%);" title="Passwort anzeigen/verbergen">
        <svg id="eyeIcon" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path> <circle cx="12" cy="12" r="3"></circle>
        </svg></button>
      </div>
      <div id="passwordError" class="hidden text-red-600 text-sm font-semibold mb-4">
       ‚ùå Falsches Passwort. Bitte versuchen Sie es erneut.
      </div><button type="submit" class="w-full bg-blue-600 hover-bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg"> Weiter </button>
     </form>
    </div>
   </div><!-- Login Screen -->
   <div id="loginScreen" class="hidden min-h-full flex items-center justify-center px-4 py-8 bg-image-overlay">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full card-overlay">
     <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Online-Pr√ºfung Anmeldung</h1>
     <p class="text-gray-600 mb-6 text-center">Hier m√ºssten Sie bei Ihrer Pr√ºfung Ihre zugeteilte Nummer eingeben. Bei uns bitte Ihren Namen.</p>
     <form id="loginForm"><label for="kennummer" class="block text-sm font-semibold text-gray-700 mb-2">Name:</label> <input type="text" id="kennummer" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-border-blue-500 focus-outline-none mb-4" placeholder="Bitte eingeben..." style="border: 2px solid #d1d5db; border-radius: 0.5rem;"> <label for="pruefungsname" class="block text-sm font-semibold text-gray-700 mb-2">Name der Pr√ºfung:</label> <input type="text" id="pruefungsname" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus-border-blue-500 focus-outline-none mb-6" placeholder="Bitte eingeben..." style="border: 2px solid #d1d5db; border-radius: 0.5rem;"> <button type="submit" class="w-full bg-blue-600 hover-bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg"> Anmelden </button>
     </form>
    </div>
   </div><!-- Confirmation Screen -->
   <div id="confirmationScreen" class="hidden min-h-full flex items-center justify-center px-4 py-8 bg-image-overlay">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-2xl w-full card-overlay">
     <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Best√§tigung</h1>
     <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
      <p class="text-gray-800 text-lg leading-relaxed">Hiermit best√§tige ich, dass ich mich mit meinem eigenen Namen <strong id="confirmedName" class="text-blue-600"></strong> eingeloggt habe und die nachfolgende Online-Pr√ºfung alleine durchf√ºhren werde.<br><br>
       Ich sehe mich heute physisch und psychisch dazu in der Lage, die Pr√ºfung zu absolvieren.</p>
     </div><button id="startEditorBtn" class="w-full bg-green-600 hover-bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg"> Best√§tigen </button>
    </div>
   </div><!-- Editor Screen -->
   <div id="editorScreen" class="hidden min-h-full flex flex-col items-center py-8 px-4"><!-- Header Bar -->
    <div class="w-full bg-white shadow-lg p-4 mb-4 flex justify-between items-start fixed z-40" style="top: 0; left: 0; right: 0;">
     <div class="flex gap-8 items-center">
      <div>
       <div class="text-sm font-semibold text-gray-600">
        Name:
       </div>
       <div id="header-kennummer" class="text-lg font-bold text-gray-800"></div>
      </div>
      <div>
       <div class="text-xs font-semibold text-red-600 mb-1">
        ‚ö† Bitte Seite nicht neuladen, da sonst Text verloren geht.
       </div>
       <div class="text-lg font-bold text-blue-600" id="header-pruefungsname"></div>
      </div>
     </div>
     <div class="flex items-center gap-4">
      <div class="flex gap-2 items-center"><button data-size="small" class="toolbar-size-btn px-3 py-2 border-2 border-gray-300 rounded-lg hover-bg-gray-100 text-sm">A</button> <button data-size="medium" class="toolbar-size-btn px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover-bg-blue-100 text-base font-semibold">A</button> <button data-size="large" class="toolbar-size-btn px-3 py-2 border-2 border-gray-300 rounded-lg hover-bg-gray-100 text-lg font-bold">A</button>
      </div>
      <div class="text-center">
       <div id="timer" class="text-2xl font-bold text-gray-800">
        06:00 Stunden
       </div>
      </div><button id="endExamBtn" class="px-6 py-3 bg-gray-300 hover-bg-gray-400 text-gray-800 font-bold rounded-lg shadow-lg transition-all"> Pr√ºfung beenden </button>
     </div>
    </div><!-- Toolbar -->
    <div id="mainToolbar" class="w-full bg-white shadow-lg p-3 flex flex-wrap gap-2 border-b-2 border-gray-200 mb-2 fixed z-30" style="top: 80px;"><button data-cmd="undo" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="R√ºckg√§ngig">‚Ü∂</button> <button data-cmd="redo" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Wiederholen">‚Ü∑</button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="cut" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Ausschneiden">‚úÇ</button> <button data-cmd="copy" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Kopieren">üìã</button> <button data-cmd="paste" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Einf√ºgen">üìÑ</button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="pageBreak" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Seitenumbruch">‚éØ‚éØ</button>
     <div class="w-px bg-gray-300 mx-1"></div><select id="formatType" class="px-3 py-2 rounded bg-gray-100 hover-bg-gray-200 border-none cursor-pointer"> <option value="p">Absatz</option> <option value="h2">Kopfzeile</option> </select>
     <div class="w-px bg-gray-300 mx-1"></div><select id="highlightSelect" class="px-3 py-2 rounded bg-gray-100 hover-bg-gray-200 border-none cursor-pointer"> <option value="">Farbauswahl aufheben</option> <option value="#d3d3d3">Grau</option> </select>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="bold" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200 font-bold">B</button> <button data-cmd="italic" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200 italic">I</button> <button data-cmd="strikeThrough" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200 line-through">S</button> <button data-cmd="superscript" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">x¬≤</button> <button data-cmd="subscript" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">x‚ÇÇ</button> <button data-cmd="redUnderline" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200 text-red-600 underline">U</button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="justifyLeft" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Linksb√ºndig">
      <svg width="16" height="16" viewbox="0 0 16 16" fill="currentColor"><rect x="2" y="2" width="12" height="2" rx="0.5" /> <rect x="2" y="6" width="8" height="2" rx="0.5" /> <rect x="2" y="10" width="10" height="2" rx="0.5" />
      </svg></button> <button data-cmd="justifyCenter" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Zentriert">
      <svg width="16" height="16" viewbox="0 0 16 16" fill="currentColor"><rect x="2" y="2" width="12" height="2" rx="0.5" /> <rect x="4" y="6" width="8" height="2" rx="0.5" /> <rect x="3" y="10" width="10" height="2" rx="0.5" />
      </svg></button> <button data-cmd="justifyRight" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Rechtsb√ºndig">
      <svg width="16" height="16" viewbox="0 0 16 16" fill="currentColor"><rect x="2" y="2" width="12" height="2" rx="0.5" /> <rect x="6" y="6" width="8" height="2" rx="0.5" /> <rect x="4" y="10" width="10" height="2" rx="0.5" />
      </svg></button> <button data-cmd="justifyFull" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200" title="Blocksatz">
      <svg width="16" height="16" viewbox="0 0 16 16" fill="currentColor"><rect x="2" y="2" width="12" height="2" rx="0.5" /> <rect x="2" y="6" width="12" height="2" rx="0.5" /> <rect x="2" y="10" width="12" height="2" rx="0.5" />
      </svg></button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="insertUnorderedList" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">‚Ä¢</button> <button data-cmd="insertOrderedList" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">1.</button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="nbsp" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">‚ê£</button> <button data-cmd="outdent" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">‚óÅ</button> <button data-cmd="indent" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">‚ñ∑</button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="table" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">‚äû</button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="specialChar" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">Œ©</button>
     <div class="w-px bg-gray-300 mx-1"></div><button data-cmd="find" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover-bg-gray-200">üîç</button>
    </div>
    <div style="height: 210px;"></div><!-- Editor Content -->
    <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg mb-8 flex" style="min-height: 600px;">
     <div class="w-1/3 bg-white p-4"></div>
     <div class="w-2/3 p-8">
      <div id="editor" class="editor-content" contenteditable="true"></div>
     </div>
    </div>
   </div><!-- Table Dialog -->
   <div id="tableDialog" class="hidden dialog-overlay">
    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
     <h3 class="font-bold mb-4 text-xl text-gray-800">Tabelle einf√ºgen</h3>
     <div class="mb-4">
      <div id="tableGrid" class="inline-block border-2 border-gray-300 rounded"></div>
      <div id="tableSelection" class="mt-3 text-sm font-semibold text-gray-700"></div>
     </div>
    </div>
   </div><!-- Special Char Dialog -->
   <div id="specialCharDialog" class="hidden dialog-overlay">
    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-80 overflow-y-auto">
     <h3 class="font-bold mb-4 text-xl text-gray-800">Sonderzeichen einf√ºgen</h3>
     <div id="specialCharGrid" class="grid grid-cols-8 gap-2"></div>
    </div>
   </div><!-- Find Replace Dialog -->
   <div id="findReplaceDialog" class="hidden fixed top-4 right-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-6 w-96 border-2 border-gray-300 relative"><button id="closeFindBtn" class="absolute w-8 h-8 flex items-center justify-center text-gray-500 hover-text-gray-800 hover-bg-gray-100 rounded-full font-bold transition-all" style="top: 1rem; right: 1rem; font-size: 1.5rem;" title="Schlie√üen"> √ó </button>
     <h3 class="font-bold mb-4 text-xl text-gray-800 pr-8">Suchen und Ersetzen</h3>
     <div class="mb-4 flex gap-2"><input type="text" id="findText" class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus-border-blue-500 focus-outline-none" placeholder="Suchen nach..." style="border: 2px solid #d1d5db; border-radius: 0.5rem;"> <button id="findNextBtn" class="px-4 py-2 bg-blue-600 hover-bg-blue-700 text-white font-semibold rounded-lg transition-all"> Suchen </button> <button id="findPrevBtn" class="px-3 py-2 bg-gray-200 hover-bg-gray-300 rounded-lg font-bold text-gray-700 transition-all" title="Vorheriges"> ‚Üë </button> <button id="findNextBtn2" class="px-3 py-2 bg-gray-200 hover-bg-gray-300 rounded-lg font-bold text-gray-700 transition-all" title="N√§chstes"> ‚Üì </button>
     </div>
     <div class="mb-4"><input type="text" id="replaceText" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus-border-blue-500 focus-outline-none" placeholder="Ersetzen durch..." style="border: 2px solid #d1d5db; border-radius: 0.5rem;">
     </div>
     <div id="findReplaceResult" class="mb-4 text-sm hidden"></div>
     <div class="flex gap-2"><button id="replaceOneBtn" class="flex-1 px-4 py-2 bg-green-600 hover-bg-green-700 text-white font-semibold rounded-lg transition-all"> Ersetzen </button> <button id="replaceAllBtn" class="flex-1 px-4 py-2 bg-orange-600 hover-bg-orange-700 text-white font-semibold rounded-lg transition-all"> Alle ersetzen </button>
     </div>
    </div>
   </div><!-- Autosave Restore Dialog -->
   <div id="autosaveDialog" class="hidden dialog-overlay">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-xl w-full mx-4">
     <h2 class="text-2xl font-bold text-gray-800 mb-4">Autosave gefunden</h2>
     <p class="text-gray-700 mb-4">Es wurde ein automatisch gespeicherter Entwurf gefunden.</p>
     <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
      <p class="text-gray-800 text-sm leading-relaxed"><strong>Name:</strong> <span id="autosave-kennummer"></span><br><strong>Pr√ºfung:</strong> <span id="autosave-pruefungsname"></span><br><strong>Gespeichert:</strong> <span id="autosave-timestamp"></span></p>
     </div>
     <div class="flex gap-4 justify-end"><button id="autosaveNewBtn" class="px-6 py-3 bg-gray-300 hover-bg-gray-400 text-gray-800 font-bold rounded-lg transition-all">Neu anfangen</button> <button id="autosaveRestoreBtn" class="px-6 py-3 bg-green-600 hover-bg-green-700 text-white font-bold rounded-lg transition-all">Wiederherstellen</button>
     </div>
    </div>
   </div><!-- End Exam Dialog -->
   <div id="endExamDialog" class="hidden dialog-overlay">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-xl w-full mx-4">
     <h2 class="text-2xl font-bold text-gray-800 mb-4">Pr√ºfung beenden?</h2>
     <p class="text-gray-700 mb-4">Wollen Sie die Pr√ºfung wirklich endg√ºltig beenden?</p>
     <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
      <p class="text-gray-800 text-sm leading-relaxed">Wenn Sie die Pr√ºfung beenden, √∂ffnet sich automatisch die Downloadm√∂glichkeit. W√§hlen Sie als Ziel bzw. Drucker <strong>"Als PDF speichern"</strong> aus. Diese PDF k√∂nnen Sie in Ihrem Benutzerkonto zur Korrektur hochladen.</p>
     </div>
     <div class="flex gap-4 justify-end"><button id="cancelEndBtn" class="px-6 py-3 bg-gray-300 hover-bg-gray-400 text-gray-800 font-bold rounded-lg transition-all">Nein</button> <button id="confirmEndBtn" class="px-6 py-3 bg-red-600 hover-bg-red-700 text-white font-bold rounded-lg transition-all">Ja, Pr√ºfung beenden</button>
     </div>
    </div>
   </div>
  </div>
  <script>
    (function() {
      'use strict';
      
      // ============================================
      // STATE MANAGEMENT
      // ============================================
      const AppState = {
        userKennummer: '',
        pruefungsname: '',
        remainingMinutes: 360,
        timerInterval: null,
        lastRange: null,
        currentSearchIndex: -1,
        searchMatches: [],
        contextMenu: null,
        AUTOSAVE_KEY: 'probeklausur_autosave',
        AUTOSAVE_INTERVAL: 120000 // 120 seconds
      };
      
      // ============================================
      // AUTOSAVE FUNCTIONALITY
      // ============================================
      function saveToLocalStorage() {
        try {
          const editor = document.getElementById('editor');
          if (!editor) return;
          
          const data = {
            content: editor.innerHTML,
            kennummer: AppState.userKennummer,
            pruefungsname: AppState.pruefungsname,
            remainingMinutes: AppState.remainingMinutes,
            timestamp: Date.now()
          };
          
          localStorage.setItem(AppState.AUTOSAVE_KEY, JSON.stringify(data));
        } catch (e) {
          console.warn('LocalStorage save failed:', e);
        }
      }
      
      function loadFromLocalStorage() {
        try {
          const saved = localStorage.getItem(AppState.AUTOSAVE_KEY);
          if (!saved) return null;
          
          const data = JSON.parse(saved);
          const age = Date.now() - data.timestamp;
          
          // Only restore if less than 24 hours old
          if (age < 24 * 60 * 60 * 1000) {
            return data;
          }
          
          // Clear old data
          localStorage.removeItem(AppState.AUTOSAVE_KEY);
          return null;
        } catch (e) {
          console.warn('LocalStorage load failed:', e);
          return null;
        }
      }
      
      function clearLocalStorage() {
        try {
          localStorage.removeItem(AppState.AUTOSAVE_KEY);
        } catch (e) {
          console.warn('LocalStorage clear failed:', e);
        }
      }
      
      function startAutosave() {
        // Save every 30 seconds
        return setInterval(saveToLocalStorage, AppState.AUTOSAVE_INTERVAL);
      }
      
      // ============================================
      // TIMER MANAGEMENT
      // ============================================
      function startTimer() {
        // Clear any existing timer
        if (AppState.timerInterval) {
          clearInterval(AppState.timerInterval);
        }
        
        updateTimerDisplay();
        
        // Single interval for countdown
        AppState.timerInterval = setInterval(function() {
          AppState.remainingMinutes--;
          updateTimerDisplay();
          
          if (AppState.remainingMinutes <= 0) {
            stopTimer();
            showTimeUpDialog();
          }
        }, 60000); // Every minute
      }
      
      function stopTimer() {
        if (AppState.timerInterval) {
          clearInterval(AppState.timerInterval);
          AppState.timerInterval = null;
        }
      }
      
      function updateTimerDisplay() {
        const hours = Math.floor(AppState.remainingMinutes / 60);
        const minutes = AppState.remainingMinutes % 60;
        const timerEl = document.getElementById('timer');
        if (timerEl) {
          timerEl.textContent = 
            hours.toString().padStart(2, '0') + ':' + 
            minutes.toString().padStart(2, '0') + ' Stunden';
        }
      }
      
      function showTimeUpDialog() {
        const dialog = document.createElement('div');
        dialog.className = 'dialog-overlay';
        dialog.innerHTML = 
          '<div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">' +
          '<h2 class="text-2xl font-bold text-red-600 mb-4">Zeit abgelaufen!</h2>' +
          '<p class="text-gray-700 mb-6">Die Pr√ºfungszeit ist abgelaufen. Bitte laden Sie Ihr Dokument herunter.</p>' +
          '<button id="timeUpDownloadBtn" class="w-full px-6 py-3 bg-green-600 hover-bg-green-700 text-white font-bold rounded-lg">Dokument herunterladen</button>' +
          '</div>';
        document.body.appendChild(dialog);
        
        document.getElementById('timeUpDownloadBtn').addEventListener('click', downloadDocument);
      }
      
      // ============================================
      // PASSWORD & LOGIN
      // ============================================
      function handlePasswordCheck(event) {
        event.preventDefault();
        const password = document.getElementById('password').value;
        const correctPassword = 'KLAUSURENWLW';
        
        if (password === correctPassword) {
          document.getElementById('passwordScreen').classList.add('hidden');
          document.getElementById('loginScreen').classList.remove('hidden');
          document.getElementById('passwordError').classList.add('hidden');
        } else {
          document.getElementById('passwordError').classList.remove('hidden');
          document.getElementById('password').value = '';
          document.getElementById('password').focus();
        }
      }
      
      function togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const eyeIcon = document.getElementById('eyeIcon');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
        } else {
          passwordInput.type = 'password';
          eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
        }
      }
      
      function handleLogin(event) {
        event.preventDefault();
        AppState.userKennummer = document.getElementById('kennummer').value.trim();
        AppState.pruefungsname = document.getElementById('pruefungsname').value.trim();
        
        if (AppState.userKennummer && AppState.pruefungsname) {
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('confirmedName').textContent = AppState.userKennummer;
          document.getElementById('confirmationScreen').classList.remove('hidden');
        }
      }
      
      function startEditor() {
        document.getElementById('confirmationScreen').classList.add('hidden');
        document.getElementById('editorScreen').classList.remove('hidden');
        document.getElementById('header-kennummer').textContent = AppState.userKennummer;
        document.getElementById('header-pruefungsname').textContent = AppState.pruefungsname;
        
        // Check for autosaved content
        const saved = loadFromLocalStorage();
        if (saved && saved.kennummer === AppState.userKennummer && saved.pruefungsname === AppState.pruefungsname) {
          showAutosaveDialog(saved);
        } else {
          startTimer();
          startAutosave();
        }
      }
      
      function showAutosaveDialog(savedData) {
        document.getElementById('autosave-kennummer').textContent = savedData.kennummer;
        document.getElementById('autosave-pruefungsname').textContent = savedData.pruefungsname;
        
        const timestamp = new Date(savedData.timestamp);
        const now = new Date();
        const diffMinutes = Math.floor((now - timestamp) / 60000);
        
        let timeText = '';
        if (diffMinutes < 1) {
          timeText = 'gerade eben';
        } else if (diffMinutes < 60) {
          timeText = 'vor ' + diffMinutes + ' Minute' + (diffMinutes > 1 ? 'n' : '');
        } else {
          const diffHours = Math.floor(diffMinutes / 60);
          timeText = 'vor ' + diffHours + ' Stunde' + (diffHours > 1 ? 'n' : '');
        }
        
        document.getElementById('autosave-timestamp').textContent = timeText;
        document.getElementById('autosaveDialog').classList.remove('hidden');
      }
      
      function hideAutosaveDialog() {
        document.getElementById('autosaveDialog').classList.add('hidden');
      }
      
      function restoreAutosave() {
        const saved = loadFromLocalStorage();
        if (saved) {
          document.getElementById('editor').innerHTML = saved.content;
          AppState.remainingMinutes = saved.remainingMinutes;
        }
        hideAutosaveDialog();
        startTimer();
        startAutosave();
      }
      
      function startNewDocument() {
        clearLocalStorage();
        hideAutosaveDialog();
        startTimer();
        startAutosave();
      }
      
      // ============================================
      // EDITOR COMMANDS
      // ============================================
      function execCommand(command, value) {
        document.execCommand(command, false, value || null);
        document.getElementById('editor').focus();
      }
      
      function handleIndentOutdent(command) {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          let element = range.startContainer;
          
          if (element.nodeType === Node.TEXT_NODE) {
            element = element.parentElement;
          }
          
          while (element && element !== document.getElementById('editor')) {
            if (element.tagName === 'P' || element.tagName === 'DIV' || element.tagName === 'H2') {
              const currentMargin = parseInt(window.getComputedStyle(element).marginLeft) || 0;
              
              if (command === 'indent') {
                element.style.marginLeft = (currentMargin + 40) + 'px';
              } else if (command === 'outdent') {
                const newMargin = Math.max(0, currentMargin - 40);
                element.style.marginLeft = newMargin + 'px';
              }
              break;
            }
            element = element.parentElement;
          }
        }
        document.getElementById('editor').focus();
      }
      
      function cutText() {
        try {
          const selection = window.getSelection();
          if (selection.toString()) {
            navigator.clipboard.writeText(selection.toString()).then(function() {
              execCommand('delete');
            });
          }
        } catch (err) {
          execCommand('cut');
        }
      }
      
      function copyText() {
        try {
          const selection = window.getSelection();
          if (selection.toString()) {
            navigator.clipboard.writeText(selection.toString());
          }
        } catch (err) {
          execCommand('copy');
        }
      }
      
      function pasteText() {
        try {
          navigator.clipboard.readText().then(function(text) {
            execCommand('insertText', text);
          });
        } catch (err) {
          execCommand('paste');
        }
      }
      
      function insertPageBreak() {
        const pageBreak = '<div style="page-break-after: always; border-top: 2px dashed #999; margin: 20px 0; padding-top: 20px;"></div>';
        execCommand('insertHTML', pageBreak);
      }
      
      function changeFormatType(tag) {
        execCommand('formatBlock', tag);
      }
      
      function highlightText(color) {
        if (color === '') {
          execCommand('removeFormat');
        } else {
          execCommand('backColor', color);
        }
      }
      
      function redUnderline() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const span = document.createElement('span');
          span.style.textDecoration = 'underline';
          span.style.textDecorationColor = 'red';
          span.style.textDecorationThickness = '2px';
          
          try {
            range.surroundContents(span);
          } catch (e) {
            const contents = range.extractContents();
            span.appendChild(contents);
            range.insertNode(span);
          }
        }
        document.getElementById('editor').focus();
      }
      
      function insertNonBreakingSpace() {
        const editor = document.getElementById('editor');
        editor.focus();
        const selection = window.getSelection();
        
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          const textNode = document.createTextNode('\u00A0');
          range.insertNode(textNode);
          range.setStartAfter(textNode);
          range.setEndAfter(textNode);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }
      
      // ============================================
      // TOOLBAR SIZE
      // ============================================
      function changeToolbarSize(size) {
        const toolbar = document.getElementById('mainToolbar');
        const buttons = document.querySelectorAll('.toolbar-size-btn');
        
        buttons.forEach(btn => {
          btn.className = 'toolbar-size-btn px-3 py-2 border-2 border-gray-300 rounded-lg hover-bg-gray-100';
          if (btn.dataset.size === 'small') btn.className += ' text-sm';
          if (btn.dataset.size === 'medium') btn.className += ' text-base font-semibold';
          if (btn.dataset.size === 'large') btn.className += ' text-lg font-bold';
        });
        
        const activeBtn = document.querySelector(`[data-size="${size}"]`);
        if (activeBtn) {
          activeBtn.className = activeBtn.className.replace('border-gray-300', 'border-blue-500 bg-blue-50');
        }
        
        if (size === 'small') {
          toolbar.className = toolbar.className.replace('p-3', 'p-2');
          toolbar.style.fontSize = '12px';
        } else if (size === 'large') {
          toolbar.className = toolbar.className.replace('p-3', 'p-4');
          toolbar.style.fontSize = '16px';
        } else {
          toolbar.className = toolbar.className.replace(/p-[24]/, 'p-3');
          toolbar.style.fontSize = '14px';
        }
      }
      
      // ============================================
      // TABLE FUNCTIONALITY
      // ============================================
      function showTableDialog() {
        document.getElementById('tableDialog').classList.remove('hidden');
        createTableGrid();
      }
      
      function hideTableDialog() {
        document.getElementById('tableDialog').classList.add('hidden');
      }
      
      function createTableGrid() {
        const grid = document.getElementById('tableGrid');
        grid.innerHTML = '';
        
        for (let row = 0; row < 10; row++) {
          const rowDiv = document.createElement('div');
          rowDiv.style.display = 'flex';
          
          for (let col = 0; col < 10; col++) {
            const cell = document.createElement('div');
            cell.style.width = '20px';
            cell.style.height = '20px';
            cell.style.border = '1px solid #ccc';
            cell.style.cursor = 'pointer';
            cell.style.transition = 'background-color 0.1s';
            cell.dataset.row = row + 1;
            cell.dataset.col = col + 1;
            
            cell.addEventListener('mouseenter', function() {
              highlightTableCells(parseInt(this.dataset.row), parseInt(this.dataset.col));
            });
            
            cell.addEventListener('click', function(e) {
              e.stopPropagation();
              insertTable(parseInt(this.dataset.row), parseInt(this.dataset.col));
            });
            
            rowDiv.appendChild(cell);
          }
          grid.appendChild(rowDiv);
        }
        
        highlightTableCells(3, 3);
      }
      
      function highlightTableCells(rows, cols) {
        const grid = document.getElementById('tableGrid');
        const allCells = grid.querySelectorAll('div[data-row]');
        
        allCells.forEach(function(cell) {
          const cellRow = parseInt(cell.dataset.row);
          const cellCol = parseInt(cell.dataset.col);
          cell.style.backgroundColor = (cellRow <= rows && cellCol <= cols) ? '#3b82f6' : 'transparent';
        });
        
        document.getElementById('tableSelection').textContent = rows + ' x ' + cols + ' Tabelle';
      }
      
      function insertTable(rows, cols) {
        const editor = document.getElementById('editor');
        const table = document.createElement('table');
        table.style.borderCollapse = 'collapse';
        table.style.width = '100%';
        table.style.margin = '10px 0';
        table.style.tableLayout = 'fixed';
        
        for (let i = 0; i < rows; i++) {
          const row = document.createElement('tr');
          for (let j = 0; j < cols; j++) {
            const cell = document.createElement('td');
            cell.style.border = '1px solid #333';
            cell.style.padding = '8px';
            cell.style.wordWrap = 'break-word';
            cell.style.overflowWrap = 'break-word';
            cell.style.whiteSpace = 'normal';
            cell.contentEditable = 'true';
            cell.innerHTML = '&nbsp;';
            cell.addEventListener('click', function(e) {
              showTableContextMenu(e, this);
            });
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
        
        editor.focus();
        const selection = window.getSelection();
        
        if (AppState.lastRange) {
          try {
            selection.removeAllRanges();
            selection.addRange(AppState.lastRange);
          } catch (e) {
            const range = document.createRange();
            range.selectNodeContents(editor);
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
        
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(table);
          
          const br = document.createElement('br');
          range.setStartAfter(table);
          range.insertNode(br);
          range.setStartAfter(br);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
          AppState.lastRange = range.cloneRange();
        } else {
          editor.appendChild(table);
          const br = document.createElement('br');
          editor.appendChild(br);
        }
        
        hideTableDialog();
        editor.focus();
      }
      
      function showTableContextMenu(event, cell) {
        event.preventDefault();
        event.stopPropagation();
        
        if (AppState.contextMenu) {
          AppState.contextMenu.remove();
        }
        
        AppState.contextMenu = document.createElement('div');
        AppState.contextMenu.style.position = 'absolute';
        AppState.contextMenu.style.backgroundColor = 'white';
        AppState.contextMenu.style.border = '2px solid #ccc';
        AppState.contextMenu.style.borderRadius = '8px';
        AppState.contextMenu.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
        AppState.contextMenu.style.zIndex = '1000';
        AppState.contextMenu.style.minWidth = '220px';
        AppState.contextMenu.style.padding = '8px 0';
        
        const table = cell.closest('table');
        const tableRect = table.getBoundingClientRect();
        const editorRect = document.getElementById('editor').getBoundingClientRect();
        
        AppState.contextMenu.style.left = (tableRect.left - editorRect.left + (tableRect.width / 2) - 110) + 'px';
        AppState.contextMenu.style.top = (tableRect.bottom - editorRect.top + 10) + 'px';
        
        const menuItems = [
          { text: 'Zeile davor einf√ºgen', action: function() { insertRowBefore(cell); } },
          { text: 'Zeile danach einf√ºgen', action: function() { insertRowAfter(cell); } },
          { text: 'Spalte davor einf√ºgen', action: function() { insertColumnBefore(cell); } },
          { text: 'Spalte danach einf√ºgen', action: function() { insertColumnAfter(cell); } },
          { text: '---', action: null },
          { text: 'Tabelle l√∂schen', action: function() { deleteTable(cell); }, danger: true }
        ];
        
        menuItems.forEach(function(item) {
          if (item.text === '---') {
            const divider = document.createElement('div');
            divider.style.height = '1px';
            divider.style.backgroundColor = '#e0e0e0';
            divider.style.margin = '4px 0';
            AppState.contextMenu.appendChild(divider);
          } else {
            const menuItem = document.createElement('div');
            menuItem.textContent = item.text;
            menuItem.style.padding = '10px 16px';
            menuItem.style.cursor = 'pointer';
            menuItem.style.fontSize = '14px';
            menuItem.style.color = item.danger ? '#dc2626' : '#333';
            menuItem.style.fontWeight = item.danger ? 'bold' : 'normal';
            
            menuItem.addEventListener('mouseenter', function() {
              this.style.backgroundColor = item.danger ? '#fee2e2' : '#f3f4f6';
            });
            
            menuItem.addEventListener('mouseleave', function() {
              this.style.backgroundColor = 'transparent';
            });
            
            menuItem.addEventListener('click', function() {
              item.action();
              hideContextMenu();
            });
            
            AppState.contextMenu.appendChild(menuItem);
          }
        });
        
        document.body.appendChild(AppState.contextMenu);
        setTimeout(function() {
          document.addEventListener('click', hideContextMenu);
        }, 100);
      }
      
      function hideContextMenu() {
        if (AppState.contextMenu) {
          AppState.contextMenu.remove();
          AppState.contextMenu = null;
        }
        document.removeEventListener('click', hideContextMenu);
      }
      
      function insertRowBefore(cell) {
        const row = cell.closest('tr');
        const colCount = row.cells.length;
        const newRow = document.createElement('tr');
        
        for (let i = 0; i < colCount; i++) {
          const newCell = createTableCell();
          newRow.appendChild(newCell);
        }
        
        row.parentNode.insertBefore(newRow, row);
      }
      
      function insertRowAfter(cell) {
        const row = cell.closest('tr');
        const colCount = row.cells.length;
        const newRow = document.createElement('tr');
        
        for (let i = 0; i < colCount; i++) {
          const newCell = createTableCell();
          newRow.appendChild(newCell);
        }
        
        if (row.nextSibling) {
          row.parentNode.insertBefore(newRow, row.nextSibling);
        } else {
          row.parentNode.appendChild(newRow);
        }
      }
      
      function insertColumnBefore(cell) {
        const table = cell.closest('table');
        const cellIndex = cell.cellIndex;
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(function(row) {
          const newCell = createTableCell();
          row.insertBefore(newCell, row.cells[cellIndex]);
        });
      }
      
      function insertColumnAfter(cell) {
        const table = cell.closest('table');
        const cellIndex = cell.cellIndex;
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(function(row) {
          const newCell = createTableCell();
          if (cellIndex + 1 < row.cells.length) {
            row.insertBefore(newCell, row.cells[cellIndex + 1]);
          } else {
            row.appendChild(newCell);
          }
        });
      }
      
      function createTableCell() {
        const cell = document.createElement('td');
        cell.style.border = '1px solid #333';
        cell.style.padding = '8px';
        cell.style.wordWrap = 'break-word';
        cell.style.overflowWrap = 'break-word';
        cell.style.whiteSpace = 'normal';
        cell.contentEditable = 'true';
        cell.innerHTML = '&nbsp;';
        cell.addEventListener('click', function(e) {
          showTableContextMenu(e, this);
        });
        return cell;
      }
      
      function deleteTable(cell) {
        const table = cell.closest('table');
        if (table) {
          table.remove();
        }
      }
      
      // ============================================
      // SPECIAL CHARACTERS
      // ============================================
      function showSpecialCharDialog() {
        document.getElementById('specialCharDialog').classList.remove('hidden');
        createSpecialCharGrid();
      }
      
      function hideSpecialCharDialog() {
        document.getElementById('specialCharDialog').classList.add('hidden');
      }
      
      function createSpecialCharGrid() {
        const grid = document.getElementById('specialCharGrid');
        grid.innerHTML = '';
        
        const specialChars = [
          '\u00B1', '\u00D7', '\u00F7', '\u2260', '\u2248', '\u2264', '\u2265', '\u221E',
          '\u2211', '\u220F', '\u221A', '\u221B', '\u221C', '\u222B', '\u2202', '\u2207',
          '\u00B0', '\u2032', '\u2033', '\u2030', '\u2031', '\u03C0', '\u03B8', '\u03A9',
          '\u2190', '\u2192', '\u2191', '\u2193', '\u2194', '\u2195', '\u21D0', '\u21D2',
          '\u21D1', '\u21D3', '\u21D4', '\u21D5', '\u2934', '\u2935', '\u21A9', '\u21AA',
          '\u25A0', '\u25A1', '\u25AA', '\u25AB', '\u25CF', '\u25CB', '\u25B2', '\u25B3',
          '\u25BC', '\u25BD', '\u25C6', '\u25C7', '\u2605', '\u2606', '\u2660', '\u2663',
          '\u2665', '\u2666', '\u2B1B', '\u2B1C', '\u25FC', '\u25FB', '\u25AE', '\u25AF',
          '\u20AC', '$', '\u00A3', '\u00A5', '\u20B9', '\u20BD', '\u20A9', '\u20AA',
          '\u00A2', '\u20B1', '\u20B4', '\u20B5', '\u201A', '\u2018', '\u2019', '\u201B',
          '\u201C', '\u201D', '\u201E', '\u201F', '\u00AB', '\u00BB', '\u2039', '\u203A',
          '\u2013', '\u2014', '\u2010', '\u2011', '\u2026', '\u2022', '\u00B7', '\u2027',
          '\u03B1', '\u03B2', '\u03B3', '\u03B4', '\u03B5', '\u03B6', '\u03B7', '\u03B8',
          '\u03B9', '\u03BA', '\u03BB', '\u03BC', '\u03BD', '\u03BE', '\u03BF', '\u03C0',
          '\u03C1', '\u03C3', '\u03C4', '\u03C5', '\u03C6', '\u03C7', '\u03C8', '\u03C9',
          '\u00C1', '\u00C0', '\u00C2', '\u00C4', '\u00C3', '\u00C5', '\u00C6', '\u00C7',
          '\u00C9', '\u00C8', '\u00CA', '\u00CB', '\u00CD', '\u00CC', '\u00CE', '\u00CF',
          '\u00D1', '\u00D3', '\u00D2', '\u00D4', '\u00D6', '\u00D5', '\u00D8', '\u0152',
          '\u00DA', '\u00D9', '\u00DB', '\u00DC', '\u00DD', '\u0178', '\u00DE', '\u00DF',
          '\u00E1', '\u00E0', '\u00E2', '\u00E4', '\u00E3', '\u00E5', '\u00E6', '\u00E7',
          '\u00E9', '\u00E8', '\u00EA', '\u00EB', '\u00ED', '\u00EC', '\u00EE', '\u00EF',
          '\u00F1', '\u00F3', '\u00F2', '\u00F4', '\u00F6', '\u00F5', '\u00F8', '\u0153',
          '\u00FA', '\u00F9', '\u00FB', '\u00FC', '\u00FD', '\u00FF', '\u00FE', '\u00F0',
          '\u00A7', '\u00B6', '\u2020', '\u2021', '\u00A9', '\u00AE', '\u2122', '\u2103',
          '\u2109', '\u2113', '\u00BC', '\u00BD', '\u00BE', '\u2153', '\u2154', '\u215B',
          '\u215C', '\u215D', '\u215E', '\u00B9', '\u00B2', '\u00B3', '\u2074', '\u2075',
          '\u2076', '\u2077', '\u2078', '\u2079', '\u2070', '\u2080', '\u2081', '\u2082',
          '\u2083', '\u2084', '\u2085', '\u2086', '\u2087', '\u2088', '\u2089', '\u00AA',
          '\u00BA', '\u00B5'
        ];
        
        specialChars.forEach(function(char) {
          const charButton = document.createElement('button');
          charButton.textContent = char;
          charButton.className = 'px-4 py-3 text-2xl border-2 border-gray-300 rounded-lg hover-bg-blue-100 hover-border-blue-500 transition-all cursor-pointer';
          charButton.title = char + ' einf√ºgen';
          charButton.addEventListener('click', function(e) {
            e.stopPropagation();
            insertSpecialChar(char);
          });
          grid.appendChild(charButton);
        });
      }
      
      function insertSpecialChar(char) {
        const editor = document.getElementById('editor');
        editor.focus();
        execCommand('insertText', char);
        hideSpecialCharDialog();
      }
      
      // ============================================
      // FIND & REPLACE
      // ============================================
      function showFindReplaceDialog() {
        document.getElementById('findReplaceDialog').classList.remove('hidden');
        document.getElementById('findText').focus();
      }
      
      function hideFindReplaceDialog() {
        document.getElementById('findReplaceDialog').classList.add('hidden');
        clearSearchHighlights();
        AppState.searchMatches = [];
        AppState.currentSearchIndex = -1;
        document.getElementById('findReplaceResult').classList.add('hidden');
      }
      
      function clearSearchHighlights() {
        const selection = window.getSelection();
        selection.removeAllRanges();
      }
      
      function findNext() {
        const findText = document.getElementById('findText').value;
        if (!findText) {
          showFindResult('Bitte geben Sie einen Suchtext ein.', 'error');
          return;
        }
        
        const editor = document.getElementById('editor');
        clearSearchHighlights();
        AppState.searchMatches = [];
        
        const walker = document.createTreeWalker(
          editor,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        
        const nodes = [];
        let node;
        while (node = walker.nextNode()) {
          nodes.push(node);
        }
        
        const searchLower = findText.toLowerCase();
        nodes.forEach(function(textNode) {
          const text = textNode.textContent;
          const textLower = text.toLowerCase();
          let index = 0;
          
          while ((index = textLower.indexOf(searchLower, index)) !== -1) {
            AppState.searchMatches.push({
              node: textNode,
              start: index,
              end: index + findText.length
            });
            index += findText.length;
          }
        });
        
        if (AppState.searchMatches.length === 0) {
          showFindResult('Keine √úbereinstimmungen gefunden.', 'error');
          AppState.currentSearchIndex = -1;
          return;
        }
        
        if (AppState.currentSearchIndex === -1) {
          AppState.currentSearchIndex = 0;
        } else {
          AppState.currentSearchIndex = (AppState.currentSearchIndex + 1) % AppState.searchMatches.length;
        }
        
        highlightCurrentMatch();
        scrollToCurrentMatch();
        showFindResult('Treffer ' + (AppState.currentSearchIndex + 1) + ' von ' + AppState.searchMatches.length, 'success');
      }
      
      function findPrevious() {
        const findText = document.getElementById('findText').value;
        if (!findText) {
          showFindResult('Bitte geben Sie einen Suchtext ein.', 'error');
          return;
        }
        
        if (AppState.searchMatches.length === 0) {
          findNext();
          return;
        }
        
        AppState.currentSearchIndex = (AppState.currentSearchIndex - 1 + AppState.searchMatches.length) % AppState.searchMatches.length;
        
        highlightCurrentMatch();
        scrollToCurrentMatch();
        showFindResult('Treffer ' + (AppState.currentSearchIndex + 1) + ' von ' + AppState.searchMatches.length, 'success');
      }
      
      function highlightCurrentMatch() {
        if (AppState.currentSearchIndex === -1 || AppState.searchMatches.length === 0) return;
        
        const match = AppState.searchMatches[AppState.currentSearchIndex];
        const range = document.createRange();
        range.setStart(match.node, match.start);
        range.setEnd(match.node, match.end);
        
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      }
      
      function scrollToCurrentMatch() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const tempSpan = document.createElement('span');
          const rangeClone = range.cloneRange();
          rangeClone.insertNode(tempSpan);
          
          tempSpan.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
          tempSpan.remove();
          
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }
      
      function replaceOne() {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        
        if (!findText) {
          showFindResult('Bitte geben Sie einen Suchtext ein.', 'error');
          return;
        }
        
        if (AppState.searchMatches.length === 0 || AppState.currentSearchIndex === -1) {
          showFindResult('Keine √úbereinstimmung ausgew√§hlt. Bitte zuerst suchen.', 'error');
          return;
        }
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          const textNode = document.createTextNode(replaceText);
          range.insertNode(textNode);
          range.setStartAfter(textNode);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        
        AppState.searchMatches = [];
        AppState.currentSearchIndex = -1;
        
        showFindResult('Ersetzt! Klicken Sie "Suchen" f√ºr die n√§chste √úbereinstimmung.', 'success');
      }
      
      function replaceAll() {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        
        if (!findText) {
          showFindResult('Bitte geben Sie einen Suchtext ein.', 'error');
          return;
        }
        
        const editor = document.getElementById('editor');
        const walker = document.createTreeWalker(
          editor,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        
        const nodes = [];
        let node;
        while (node = walker.nextNode()) {
          nodes.push(node);
        }
        
        let totalCount = 0;
        const regex = new RegExp(escapeRegex(findText), 'gi');
        
        nodes.forEach(function(textNode) {
          const text = textNode.textContent;
          const matches = text.match(regex);
          
          if (matches) {
            totalCount += matches.length;
            textNode.textContent = text.replace(regex, replaceText);
          }
        });
        
        clearSearchHighlights();
        AppState.searchMatches = [];
        AppState.currentSearchIndex = -1;
        
        if (totalCount > 0) {
          showFindResult(totalCount + ' √úbereinstimmung(en) ersetzt.', 'success');
        } else {
          showFindResult('Keine √úbereinstimmungen gefunden.', 'error');
        }
      }
      
      function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }
      
      function showFindResult(message, type) {
        const resultDiv = document.getElementById('findReplaceResult');
        resultDiv.textContent = message;
        resultDiv.className = 'mb-4 text-sm font-semibold ' + (type === 'error' ? 'text-red-600' : 'text-green-600');
        resultDiv.classList.remove('hidden');
      }
      
      // ============================================
      // DOWNLOAD / PRINT
      // ============================================
      function downloadDocument() {
        let printDiv = document.getElementById('printContent');
        if (!printDiv) {
          printDiv = document.createElement('div');
          printDiv.id = 'printContent';
          printDiv.style.display = 'none';
          document.body.appendChild(printDiv);
        }
        
        const editor = document.getElementById('editor');
        const header = 
          '<div class="print-header">' +
          '<div style="display: flex; justify-content: space-between; align-items: center;">' +
          '<div><strong>Name:</strong> ' + AppState.userKennummer + '</div>' +
          '<div style="text-align: center;"><strong>' + AppState.pruefungsname + '</strong></div>' +
          '</div>' +
          '</div>';
        
        const content = editor.cloneNode(true);
        content.classList.add('print-content');
        
        const layoutWrapper = 
          '<div style="display: flex; width: 100%;">' +
          '<div style="width: 33.33%; border-right: 1px solid #ccc;"></div>' +
          '<div style="width: 66.67%; padding-left: 20px;">' + content.outerHTML + '</div>' +
          '</div>';
        
        printDiv.innerHTML = header + layoutWrapper;
        printDiv.style.display = 'block';
        
        const originalTitle = document.title;
        document.title = AppState.pruefungsname + '_' + AppState.userKennummer;
        
        window.print();
        
        setTimeout(function() {
          document.title = originalTitle;
          printDiv.style.display = 'none';
        }, 1000);
      }
      
      // ============================================
      // END EXAM
      // ============================================
      function showEndExamDialog() {
        document.getElementById('endExamDialog').classList.remove('hidden');
      }
      
      function hideEndExamDialog() {
        document.getElementById('endExamDialog').classList.add('hidden');
      }
      
      function endExam() {
        stopTimer();
        hideEndExamDialog();
        
        const message = document.createElement('div');
        message.className = 'fixed bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
        message.style.top = '1rem';
        message.style.right = '1rem';
        message.textContent = 'Pr√ºfung beendet. PDF wird heruntergeladen...';
        document.body.appendChild(message);
        
        setTimeout(function() {
          downloadDocument();
          clearLocalStorage();
          setTimeout(function() {
            message.remove();
          }, 3000);
        }, 500);
      }
      
      // ============================================
      // EVENT LISTENERS SETUP
      // ============================================
      function setupEventListeners() {
        // Password form
        document.getElementById('passwordForm').addEventListener('submit', handlePasswordCheck);
        document.getElementById('togglePasswordBtn').addEventListener('click', togglePasswordVisibility);
        
        // Login form
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        
        // Start editor
        document.getElementById('startEditorBtn').addEventListener('click', startEditor);
        
        // Autosave dialog
        document.getElementById('autosaveRestoreBtn').addEventListener('click', restoreAutosave);
        document.getElementById('autosaveNewBtn').addEventListener('click', startNewDocument);
        
        // End exam
        document.getElementById('endExamBtn').addEventListener('click', showEndExamDialog);
        document.getElementById('cancelEndBtn').addEventListener('click', hideEndExamDialog);
        document.getElementById('confirmEndBtn').addEventListener('click', endExam);
        
        // Toolbar size buttons
        document.querySelectorAll('.toolbar-size-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            changeToolbarSize(this.dataset.size);
          });
        });
        
        // Toolbar commands
        document.querySelectorAll('[data-cmd]').forEach(btn => {
          btn.addEventListener('click', function() {
            const cmd = this.dataset.cmd;
            
            switch(cmd) {
              case 'undo': execCommand('undo'); break;
              case 'redo': execCommand('redo'); break;
              case 'cut': cutText(); break;
              case 'copy': copyText(); break;
              case 'paste': pasteText(); break;
              case 'pageBreak': insertPageBreak(); break;
              case 'bold': execCommand('bold'); break;
              case 'italic': execCommand('italic'); break;
              case 'strikeThrough': execCommand('strikeThrough'); break;
              case 'superscript': execCommand('superscript'); break;
              case 'subscript': execCommand('subscript'); break;
              case 'redUnderline': redUnderline(); break;
              case 'justifyLeft': execCommand('justifyLeft'); break;
              case 'justifyCenter': execCommand('justifyCenter'); break;
              case 'justifyRight': execCommand('justifyRight'); break;
              case 'justifyFull': execCommand('justifyFull'); break;
              case 'insertUnorderedList': execCommand('insertUnorderedList'); break;
              case 'insertOrderedList': execCommand('insertOrderedList'); break;
              case 'nbsp': insertNonBreakingSpace(); break;
              case 'indent': handleIndentOutdent('indent'); break;
              case 'outdent': handleIndentOutdent('outdent'); break;
              case 'table': showTableDialog(); break;
              case 'specialChar': showSpecialCharDialog(); break;
              case 'find': showFindReplaceDialog(); break;
            }
          });
        });
        
        // Format type select
        document.getElementById('formatType').addEventListener('change', function() {
          changeFormatType(this.value);
        });
        
        // Highlight select
        document.getElementById('highlightSelect').addEventListener('change', function() {
          highlightText(this.value);
        });
        
        // Find/Replace
        document.getElementById('closeFindBtn').addEventListener('click', hideFindReplaceDialog);
        document.getElementById('findNextBtn').addEventListener('click', findNext);
        document.getElementById('findNextBtn2').addEventListener('click', findNext);
        document.getElementById('findPrevBtn').addEventListener('click', findPrevious);
        document.getElementById('replaceOneBtn').addEventListener('click', replaceOne);
        document.getElementById('replaceAllBtn').addEventListener('click', replaceAll);
        
        document.getElementById('findText').addEventListener('keyup', function(e) {
          if (e.key === 'Enter') findNext();
        });
        
        // Dialog click handlers
        document.getElementById('tableDialog').addEventListener('click', function(e) {
          if (e.target === this) hideTableDialog();
        });
        
        document.getElementById('specialCharDialog').addEventListener('click', function(e) {
          if (e.target === this) hideSpecialCharDialog();
        });
        
        // Editor range tracking
        const editor = document.getElementById('editor');
        
        editor.addEventListener('blur', function() {
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            AppState.lastRange = selection.getRangeAt(0).cloneRange();
          }
        });
        
        editor.addEventListener('keyup', function() {
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            AppState.lastRange = selection.getRangeAt(0).cloneRange();
          }
        });
        
        editor.addEventListener('mouseup', function() {
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            AppState.lastRange = selection.getRangeAt(0).cloneRange();
          }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
          if (e.ctrlKey || e.metaKey) {
            switch(e.key.toLowerCase()) {
              case 'z':
                if (!e.shiftKey) {
                  e.preventDefault();
                  execCommand('undo');
                }
                break;
              case 'y':
                e.preventDefault();
                execCommand('redo');
                break;
            }
          }
        });
      }
      
      // ============================================
      // ELEMENT SDK
      // ============================================
      const defaultConfig = { document_title: "Mein Dokument" };
      
      function onConfigChange(config) {}
      
      function mapToCapabilities(config) {
        return {
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        };
      }
      
      function mapToEditPanelValues(config) {
        return new Map([
          ["document_title", config.document_title || defaultConfig.document_title]
        ]);
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig: defaultConfig,
          onConfigChange: onConfigChange,
          mapToCapabilities: mapToCapabilities,
          mapToEditPanelValues: mapToEditPanelValues
        });
      }
      
      // ============================================
      // INITIALIZATION
      // ============================================
      document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
      });
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', function() {
        stopTimer();
        saveToLocalStorage();
      });
      
    })();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ae7211f567fe0d3',t:'MTc2NTgxNDE2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
